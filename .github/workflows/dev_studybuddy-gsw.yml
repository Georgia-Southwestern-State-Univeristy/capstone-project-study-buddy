name: Build and Deploy Angular App to Azure Web App - studybuddy-Gsw

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
 build:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '22.x'

    - name: Install Angular CLI
      run: npm install -g @angular/cli

    - name: Install dependencies and build
      run: |
        cd meme_mingle
        npm install
        ng build

    - name: Copy dist into root for server to serve
      run: |
        mkdir meme_mingle/build
        cp -r meme_mingle/dist/meme-mingle meme_mingle/build/dist
        cp meme_mingle/server.js meme_mingle/build/
        cp meme_mingle/package.json meme_mingle/build/
        cp -r meme_mingle/node_modules meme_mingle/build/

    - name: Zip build
      run: |
        cd meme_mingle/build
        zip -r ../../release.zip .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: angular-dist
        path: release.zip


 deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: angular-dist
          path: .

      - name: Unzip artifact
        run: unzip release.zip

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'studybuddy-Gsw'
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_A78A924CE36A49C5BBB15A3DC10C2BDC }}
          package: '.'
